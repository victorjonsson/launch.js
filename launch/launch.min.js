/** * * * * * * * * * * * * * * * * * * * * *
 * launch.js - Web app distribution system
 *
 * @version 1.1
 * @author Victor Jonsson (http://www.victorjonsson)
 * @license Dual licensed under the MIT and the GPLv2 licenses
 */
var WebApp=function(e){"use strict";var t=!1,n=!1;e.navigator.userAgent.toLowerCase().indexOf("msie ")>-1&&(n=10>parseFloat(navigator.appVersion.split("MSIE")[1]));var i=!1;try{var s=document.createElement("canvas");i="toDataURL"in s&&"getContext"in s}catch(a){}var o={versionToFloat:function(e){if(!e)return 0;var t=e.split("."),n=t.splice(0,1)[0];return parseFloat(n+"."+t.join(""))},createElement:function(t,n,i){var s=e.document.createElement(t);return s.innerHTML=n,"string"==typeof i?e.document.getElementsByTagName(i)[0].appendChild(s):"object"==typeof i&&i&&i.appendChild(s),s},parseJSON:function(e){try{if(!n)return JSON.parse(e);e=e.replace(/^\s\s*/,"").replace(/\s\s*$/,"");var t=/^[\],:{}\s]*$/,i=/(?:^|:|,)(?:\s*\[)+/g,s=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,a=/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g;if(t.test(e.replace(s,"@").replace(a,"]").replace(i,"")))return Function("return "+e)()}catch(o){}throw Error("Unable to parse JSON")},isImageFile:function(e){var t=e.substr(e.length-4,4).toLowerCase();return"jpeg"==t||".jpg"==t||".gif"==t||".png"==t}},r={listeners:{},on:function(e,t){void 0===this.listeners[e]&&(this.listeners[e]=[]),this.listeners[e].push(t)},call:function(e,t){if(void 0!==this.listeners[e])for(var n=0;this.listeners[e].length>n;n++)this.listeners[e][n](t)}},l=function(e,n){console&&("debug"!=n&&n||!t?"info"==n&&console.log(e):console.log("DEBUG: "+e))};return{events:r,filesToLoad:0,concurrentRequests:0,resources:{},manifest:null,isDownloaded:!1,start:function(){var t=this;this.request("app.manifest",function(s){t.manifest=o.parseJSON(s);var a=o.versionToFloat(e.localStorage.getItem(t.manifest.name+"-app-version")),r=o.versionToFloat(t.manifest.version);t.isDownloaded=r==a,l("Manfiest loaded, calling event init"),t.events.call("init"),(n||!i)&&(l("Moving images to no cache"),t.moveImagesToNoCache()),t.isDownloaded?(l("Fetching app files from local storage","info"),t.downloadUnCachedFiles(function(){t.initiateFiles()})):(l("Downloading new app","info"),t.downloadApp(a))})},moveImagesToNoCache:function(){this.manifest.nocache||(this.manifest.nocache=[]);for(var e=this,t=function(t){for(var n=0;e.manifest.files.length>n;n++)if(e.manifest.files[n]==t)return n},n=this.manifest.files.slice(0,this.manifest.files.length),i=0;n.length>i;i++)o.isImageFile(n[i])&&(this.manifest.nocache.push(n[i]),this.manifest.files.splice(t(n[i]),1))},addToDOM:function(e,t){var n=t.substr(t.length-4,4).toLowerCase();if(".js"==t.substr(t.length-3,3))o.createElement("SCRIPT",e,"head");else if(".css"==n)o.createElement("STYLE",e,"head");else if("json"==n)this.resources[t]=o.parseJSON(e);else if(o.isImageFile(t)&&"string"==typeof e){var i=new Image;i.src=e,this.resources[t]=i}else this.resources[t]=e},downloadApp:function(t){var n=this,i=this.manifest.name;this.filesToLoad=this.manifest.files.length,t&&this.removeApp(),e.localStorage.setItem(this.manifest.name+"-app-version",this.manifest.version);for(var s=0;this.manifest.files.length>s;s++){if(this.halt){l("halted download...","info");break}this.request(this.manifest.files[s],function(t,s){if(l(s+" downloaded"),!n.halt){try{e.localStorage.setItem(i+"-file-"+s,t)}catch(a){return l(a,"info"),n.events.call("QuotaExceeded"),n.halt=!0,void 0}n.events.call("download",s),n.filesToLoad--,0==n.filesToLoad&&(e.localStorage.setItem(n.manifest.name+"-app-files",n.manifest.files.join("<file-divider />")),n.downloadUnCachedFiles(function(){n.initiateFiles()}))}})}},initiateFiles:function(){for(var t=0;this.manifest.files.length>t;t++){var n=this.manifest.files[t],i=e.localStorage.getItem(this.manifest.name+"-file-"+n);this.addToDOM(i,n)}var s=this;setTimeout(function(){s.events.call("load"),l("App loaded","info")},100)},downloadUnCachedFiles:function(t){var n,i=this;if(l("Downloading uncached files","info"),this.manifest.nocache){var s=this.manifest.nocache.length,a=e.document.getElementsByTagName("head")[0];for(n=0;this.manifest.nocache.length>n;n++){var o=this.manifest.nocache[n];if(".js"==o.substr(o.length-3,3)){var r=e.document.createElement("SCRIPT");r.onload=function(){s--,0==s&&t()},r.src=o,a.appendChild(r)}else this.request(o,function(e,n){i.addToDOM(e,n),s--,0==s&&t()})}}else t()},removeApp:function(){l("Removing old app"),e.localStorage.removeItem(this.manifest.name+"-app-version");var t=e.localStorage.getItem(this.manifest.name+"-app-files");if(t){t=t.split("<file-divider />");for(var n=0;t.length>n;n++)e.localStorage.removeItem(this.manifest.name+"-file-"+t[n])}e.localStorage.removeItem(this.manifest.name+"-app-files")},request:function(t,n){var s=this;this.concurrentRequests>4?(l(t+" being queued for download"),setTimeout(function(){s.request(t,n)},500)):(this.concurrentRequests++,setTimeout(function(){var a=t.substr(t.length-4,4).toLocaleLowerCase();"jpeg"!=a&&(a=a.substr(1,3)),"jpg"==a&&(a="jpeg");var r=o.isImageFile(t);if(l(t+" starting download"),r){var c=document.createElement("IMG");c.onload=function(){if(s.concurrentRequests--,i){l("Downloaded image "+t+" using canvas");var e=document.createElement("canvas"),o=e.getContext("2d");e.width=this.width,e.height=this.height,o.drawImage(this,0,0,this.width,this.height),n(e.toDataURL("image/"+a),t)}else n(this,t)},c.onerror=function(){s.concurrentRequests--,l(t+" failed to load (image), retrying...","info"),s.request(t,n)},c.src=t}else{var d="XMLHttpRequest"in e?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");"overrideMimeType"in d&&d.overrideMimeType("text/plain; charset=x-user-defined"),d.onreadystatechange=function(){4==d.readyState&&(s.concurrentRequests--,200!=d.status?(l(t+" responded with status "+d.status+", retrying...","info"),s.request(t,n)):n(d.responseText,t))},d.open("GET",t,!1),d.send()}},50))},on:function(e,t){this.events.on(e,t)}}}(window);(function(e,t){var n,i,s,a,o,r=function(e){var t=n.style.opacity;t=(t?parseFloat(t):1)-.04,n.style.opacity=t,n.style.filter="alpha("+100*t+")",t>0?setTimeout(function(){r(e)},10):e()};n=document.getElementById("launch-panel"),o=document.getElementById("launch-progress-bar"),a=document.getElementById("launch-progress-info"),n.style.position="absolute",n.style.width="200px",n.style.height="200px",n.style.left="50%",n.style.top="50%",n.style.padding="20px 25px 0",n.style.margin="-180px 0 0 -130px",o.parentNode.style.height="22px",o.parentNode.style.height="22px",o.parentNode.style.margin="20px 0 8px",o.parentNode.style.overflow="hidden",o.style.height="100%",o.style.width="0",n.style.display="block",e.on("init",function(){a.innerHTML='Downloaded <span id="loaded-launch-files"></span> of <span id="num-launch-files"></span> files',s=document.getElementById("num-launch-files"),i=document.getElementById("loaded-launch-files"),e.isDownloaded?(o.style.width="100%",a.innerHTML="Application loaded from local storage..."):(s.innerHTML=e.manifest.files.length,i.innerHTML="0")}),e.on("download",function(){if(!e.isDownloaded){var t=parseInt(i.innerHTML)+1,n=Math.round(100*(t/e.manifest.files.length));o.style.width=n+"%",i.innerHTML=t,t==e.manifest.files.length&&(a.innerHTML="Application downloaded...")}}),e.on("QuotaExceeded",function(){o.parentNode.parentNode.removeChild(o.parentNode),a.style.textAlign="center",a.style.paddingTop="10px",a.style.lineHeight="130%",a.innerHTML='<strong style="color:red">ERROR<br /></strong><strong>Local storage quoata exceeded.</strong> <br /> You have to increase the local storage quota in your browser in order to run this web app.'}),e.on("load",function(){r(function(){var n=e.manifest.main;n&&(t.document.getElementsByTagName("body")[0].innerHTML=e.resources[n]),e.events.call("ready")})}),setTimeout(function(){e.start()},500)})(WebApp,window);