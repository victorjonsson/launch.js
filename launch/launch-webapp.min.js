/** * * * * * * * * * * * * * * * * * * * * *
 * launch.js - Web app distribution system
 *
 * @version 1.1.9
 * @author Victor Jonsson (http://www.victorjonsson)
 * @license Dual licensed under the MIT and the GPLv2 licenses
 */var WebApp=function(e){"use strict";var t=!0,n=!1;e.navigator.userAgent.toLowerCase().indexOf("msie ")>-1&&(n=10>parseFloat(navigator.appVersion.split("MSIE")[1]));var i=!1;try{var s=document.createElement("canvas");i="toDataURL"in s&&"getContext"in s}catch(a){}var o={versionToFloat:function(e){if(!e)return 0;var t=e.split("."),n=t.splice(0,1)[0];return parseFloat(n+"."+t.join(""))},createElement:function(t,n,i){var s=e.document.createElement(t);return s.innerHTML=n,"string"==typeof i?o.elem(i).appendChild(s):"object"==typeof i&&i&&i.appendChild(s),s},elem:function(t,n,i){i||(i="getElementsByTagName");var s=e.document[i](t);if(!n)return s[0];for(var a=0;s.length>a&&n(s[a],a)!==!1;a++);},parseJSON:function(e){try{if(!n)return JSON.parse(e);e=e.replace(/^\s\s*/,"").replace(/\s\s*$/,"");var t=/^[\],:{}\s]*$/,i=/(?:^|:|,)(?:\s*\[)+/g,s=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,a=/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g;if(t.test(e.replace(s,"@").replace(a,"]").replace(i,"")))return Function("return "+e)()}catch(o){}throw Error("Unable to parse JSON")},isImageFile:function(e){var t=e.substr(e.length-4,4).toLowerCase();return"jpeg"==t||".jpg"==t||".gif"==t||".png"==t}},r={listeners:{},on:function(e,t){void 0===this.listeners[e]&&(this.listeners[e]=[]),this.listeners[e].push(t)},call:function(e,t){if(void 0!==this.listeners[e])for(var n=0;this.listeners[e].length>n;n++)this.listeners[e][n](t)}},l=function(e,n){console&&("debug"!=n&&n||!t?"info"==n&&console.log(e):console.log("DEBUG: "+e))};return{events:r,filesToLoad:0,concurrentRequests:0,resources:{},manifest:null,isDownloaded:!1,basePath:"",start:function(){var t=this,s="app.manifest";o.elem("meta",function(e){return"app-manifest"===e.getAttribute("name")?(s=e.getAttribute("content"),!1):void 0}),this.request(s,function(s){t.manifest=o.parseJSON(s);var a=o.versionToFloat(e.localStorage.getItem(t.manifest.name+"-app-version")),r=o.versionToFloat(t.manifest.version);t.isDownloaded=r==a,l("Manfiest loaded, calling event init"),t.events.call("init"),(n||!i)&&(l("Moving images to no cache"),t.moveImagesToNoCache()),t.isDownloaded?(l("Fetching app files from local storage","info"),t.downloadUnCachedFiles(function(){t.initiateFiles()})):(l("Downloading new app","info"),t.downloadApp(a))})},moveImagesToNoCache:function(){this.manifest.nocache||(this.manifest.nocache=[]);for(var e=this,t=function(t){for(var n=0;e.manifest.files.length>n;n++)if(e.manifest.files[n]==t)return n;return-1},n=this.manifest.files.slice(0,this.manifest.files.length),i=0;n.length>i;i++)o.isImageFile(n[i])&&(this.manifest.nocache.push(n[i]),this.manifest.files.splice(t(n[i]),1))},addToDOM:function(e,t){var n=t.substr(t.length-4,4).toLowerCase();if(".js"==t.substr(t.length-3,3))o.createElement("SCRIPT",e,"head");else if(".css"==n)o.createElement("STYLE",e,"head");else if("json"==n)this.resources[t]=o.parseJSON(e);else if(o.isImageFile(t)&&"string"==typeof e){var i=new Image;i.src=e,this.resources[t]=i}else this.resources[t]=e},downloadApp:function(t){var n=this,i=this.manifest.name;this.filesToLoad=this.manifest.files.length,t&&this.removeApp(),e.localStorage.setItem(this.manifest.name+"-app-version",this.manifest.version),o.elem("meta",function(e){return"app-base-path"===e.getAttribute("name")?(n.basePath=e.getAttribute("content"),!1):void 0});for(var s=0;this.manifest.files.length>s;s++){if(this.halt){l("halted download...","info");break}this.request(this.manifest.files[s],function(t,s){if(l(s+" downloaded"),!n.halt){try{e.localStorage.setItem(i+"-file-"+s,t)}catch(a){return l(a,"info"),n.events.call("QuotaExceeded"),n.halt=!0,void 0}n.events.call("download",s),n.filesToLoad--,0==n.filesToLoad&&(e.localStorage.setItem(n.manifest.name+"-app-files",n.manifest.files.join("<file-divider />")),n.downloadUnCachedFiles(function(){n.initiateFiles()}))}})}},initiateFiles:function(){for(var t=0;this.manifest.files.length>t;t++){var n=this.manifest.files[t],i=e.localStorage.getItem(this.manifest.name+"-file-"+n);this.addToDOM(i,n)}var s=this;s.events.call("load"),l("App loaded","info")},downloadUnCachedFiles:function(t){var n,i=this;if(l("Downloading uncached files","info"),this.manifest.nocache&&this.manifest.nocache.length){var s=this.manifest.nocache.length,a=o.elem("head");for(n=0;this.manifest.nocache.length>n;n++){var r=this.manifest.nocache[n];if(".js"==r.substr(r.length-3,3)){var f=e.document.createElement("SCRIPT");f.onload=function(){s--,0==s&&t()},f.src=r,a.appendChild(f)}else this.request(r,function(e,n){i.addToDOM(e,n),s--,0==s&&t()})}}else t()},removeApp:function(){l("Removing old app"),e.localStorage.removeItem(this.manifest.name+"-app-version");var t=e.localStorage.getItem(this.manifest.name+"-app-files");if(t){t=t.split("<file-divider />");for(var n=0;t.length>n;n++)e.localStorage.removeItem(this.manifest.name+"-file-"+t[n])}e.localStorage.removeItem(this.manifest.name+"-app-files")},request:function(t,n){var s=this;if(this.concurrentRequests>4)l(t+" being queued for download"),setTimeout(function(){s.request(t,n)},50);else{this.concurrentRequests++;var a=t.indexOf("://"),r=a>-1&&6>a?t:s.basePath+t,f=t.substr(t.length-4,4).toLocaleLowerCase(),c=o.isImageFile(t);if("jpeg"!=f&&(f=f.substr(1,3)),"jpg"==f&&(f="jpeg"),l(t+" starting download"),this.manifest&&(r+=(r.indexOf("?")>-1?"&":"?")+"v="+this.manifest.version),c){var h=e.document.createElement("IMG");h.onload=function(){if(s.concurrentRequests--,i){l("Downloaded image "+t+" using canvas");var a=e.document.createElement("canvas"),o=a.getContext("2d");a.width=this.width,a.height=this.height,o.drawImage(this,0,0,this.width,this.height),n(a.toDataURL("image/"+f),t)}else n(this,t)},h.onerror=function(){s.concurrentRequests--,l(t+" failed to load (image), retrying...","info"),s.request(t,n)},h.src=r}else{var d="XMLHttpRequest"in e?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");"overrideMimeType"in d&&d.overrideMimeType("text/plain; charset=x-user-defined"),d.onreadystatechange=function(){4==d.readyState&&(s.concurrentRequests--,200!=d.status?(l(t+" responded with status "+d.status+", retrying...","info"),s.request(t,n)):n(d.responseText,t))},d.open("GET",r,!0),d.send()}}},on:function(e,t){this.events.on(e,t)}}}(window);